<!DOCTYPE html>
<head>
<meta charset="utf-8">
  <meta name="author" content="Rowan J. Gollan" />
  <meta name="dcterms.date" content="2016-03-10" />
  <title>The Case for Open Source in Research and what we’re doing with eilmer</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
<style>
  html { background-color: black; }
  body { background-color: black; border-radius: 12px}
  /* A section is a slide. It's size is 800x600, and this will never change */
  section {
      font-family: Palatino, serif;
      font-size: 16pt;
      color: white;
    }
  address, blockquote, dl, fieldset, form, h1, h2, h3, h4, h5, h6, hr, ol, p, pre, table, ul, dl { padding: 10px 20px 10px 20px; }
  h1, h2, h3 {
    text-align: center;
    margin: 10pt 10pt 20pt 10pt;
  }
  ul, ol {
    margin: 10px 10px 10px 50px;
  }
  section.titleslide h1 { margin-top: 200px; }
  h1.title { margin-top: 150px; }
  h1 { font-size: 150%; }
  h2 { font-size: 120%; }
  h3 { font-size: 100%; }
  q { quotes: "“" "”" "‘" "’"; }
  blockquote { font-style: italic;
               font-size: 18pt; }
  pre { font-size: 13pt; }
  dt {
    font-weight: bold;
    font-size: 18pt;
  }
  dd {
    font-size: 16pt;
    margin: 0 0 0 40px;
    padding: 0 0 0.25em 0;
  }
  /* Figures are displayed full-page, with the caption on
     top of the image/video */
  figure {
    background-color: black;
  }
  figcaption {
    margin: 70px;
  }
  footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    padding: 40px;
    text-align: right;
    background-color: #F3F4F8;
    border-top: 1px solid #CCC;
  }

  /* Transition effect */
  /* Feel free to change the transition effect for original
     animations. See here:
     https://developer.mozilla.org/en/CSS/CSS_transitions
     How to use CSS3 Transitions: */
  /*
  section {
      -moz-transition: left 400ms linear 0s;
      -webkit-transition: left 400ms linear 0s;
      -ms-transition: left 400ms linear 0s;
      transition: left 400ms linear 0s;
  }
  */
  /* Before */
  section { left: -150%; }
  /* Now */
  section[aria-selected] { left: 0; }
  /* After */
  section[aria-selected] ~ section { left: +150%; }

  /* Incremental elements */

  /* By default, visible */
  .incremental > * { opacity: 1; }

  /* The current item */
  .incremental > *[aria-selected] { color: red; opacity: 1; }

  /* The items to-be-selected */
  .incremental > *[aria-selected] ~ * { opacity: 0.2; }
</style>
</head>
<body>
<section class="title">
  <h1 class="title">The Case for Open Source in Research<br> <small><em>and what we’re doing with eilmer</em></small></h1>
  <h2 class="author">Rowan J. Gollan</h2>
  <h3 class="date">10 March 2016</h3>
</section>
<section id="outline" class="slide level1">
<h1>Outline</h1>
</section>
<section id="the-scientific-method" class="slide level1">
<h1>The Scientific Method</h1>
<blockquote>
<p>a method or procedure that has characterized natural science since the 17th century consisting in systematic observation, measurement, and experiment, and the formulation, testing, and modification of hypothesis</p>
<blockquote>
<p>– <cite>Oxford English Dictionary</cite></p>
</blockquote>
</blockquote>
<blockquote>
<p>Science is the systematic enterprise of gathering knowledge about the universe and organizing and condensing that knowledge into testable laws and theories. The success and credibility of science are anchored in their willingness to expose their ideas and results to independent testing and replication by other scientists. This requires the complete and open exchange of data, procedures and materials.</p>
<blockquote>
<p>– <cite>American Physical Society</cite></p>
</blockquote>
</blockquote>
</section>
<section id="the-mertonian-norms-1942" class="slide level1">
<h1>The Mertonian Norms (1942)</h1>
<dl>
<dt>Communalism</dt>
<dd>all scientists should have equal access to scientific goods (intellectual property) and there should be a sense of common ownership in order to promote collective collaboration, secrecy is the opposite of this norm.
</dd>
<dt>Universalism</dt>
<dd>all scientists can contribute to science regardless of race, nationality, culture, or gender.
</dd>
<dt>Disinterestedness</dt>
<dd>according to which scientists are supposed to act for the benefit of a common scientific enterprise, rather than for personal gain.
</dd>
<dt>Organized Skepticism</dt>
<dd>skepticism means that scientific claims must be exposed to critical scrutiny before being accepted.
</dd>
</dl>
<p><small><em>Here shown in the form given by Ziman (2000).</em></small></p>
</section>
<section id="branches-of-science" class="slide level1">
<h1>Branches of science</h1>
<blockquote>
<p>The motivation for using the scientific method is to route out error.</p>
</blockquote>
<p>Two established branches of science:</p>
<dl>
<dt>Deductive branch</dt>
<dd>concept of proof
</dd>
<dt>Empirical branch</dt>
<dd>hypothesis testing, structured communication of methods and protocols
</dd>
</dl>
<p>One or two emerging branches of science:</p>
<dl>
<dt>Computational science</dt>
<dd>process of discovery involves (large-scale) computer simulation
</dd>
<dt>Data-driven science</dt>
<dd>???
</dd>
</dl>
</section>
<section id="section" class="slide level1">
<h1></h1>
<p><img src="images/science-cover.png" /><br /></p>
</section>
<section id="section-1" class="slide level1">
<h1></h1>
<p><img src="images/comp-sci-debuts.png" /><br /></p>
</section>
<section id="computational-science-a-new-branch-of-science" class="slide level1">
<h1>Computational science: a new branch of science?</h1>
<p><em> What might distinguish computational science from other branches? </em></p>
<ul>
<li><u>not</u> a new method of enquiry
<ul>
<li>we’ve always used computation as part of testing theory [Vardi, 2010]</li>
<li>consider it as a virtual experiment</li>
</ul></li>
<li><u>distinguished by</u>
<ul>
<li>how we <u>should</u> disseminate the knowledge</li>
<li>how we should follow the Mertonian norms</li>
</ul></li>
</ul>
</section>
<section id="a-historical-diversion-publishing-in-journals" class="slide level1">
<h1>A historical diversion: publishing in journals</h1>
<p><em> What has worked to disseminate science in the empirical branch? </em></p>
<p>Publishing in archival journals with a detailed description of Materials and Methods sufficient for replication.</p>
<table>
<col style="width: 13%" /><col style="width: 86%" /><tbody>
<tr class="odd">
<td style="text-align: left;">Note:</td>
<td style="text-align: left;">The first scientific journal, the Transactions of the Royal Society London, was created primarily to establish precedence of discoveries. This also became a means of dissemination and had a peer-review. After a few issues, it was realised that the transactions were also a great archive.</td>
</tr>
</tbody>
</table>
<p><small>That first journal did what we still think of as the role of journals today: registration, dissemination, peer-review, and archival record.</small></p>
</section>
<section id="the-standard-for-reporting" class="slide level1">
<h1>The standard for reporting</h1>
<p><img src="images/robert_boyle.jpg" /><br /></p>
<blockquote>
<p>that the person I addressed them to might, without mistake, and with as little trouble as possible, be able to repeat such unusual experiments.</p>
<blockquote>
<p>– <cite>New Experiments, 1660, Robert Boyle</cite></p>
</blockquote>
</blockquote>
</section>
<section id="the-problem-in-computational-science" class="slide level1">
<h1>The problem in computational science</h1>
<blockquote>
<p>an article about computational science in a scientific publication is <u>not</u> the scholarship itself, it’s merely scholarship advertisement. The actual scholarship is the complete software development environment and the complete set of instructions that generated the figures.</p>
<blockquote>
<p>– <cite>Jon Clarebout, paraphrased by Donoho (1998)</cite></p>
</blockquote>
</blockquote>
<p>My thesis: computational science has lost its way with regards to the scientific method. Our work often fails to be replicable, it lacks transparency of communication, and is unverifiable. This hinders or makes it impossible to root out error.</p>
</section>
<section id="the-extent-of-the-problem" class="slide level1">
<h1>The extent of the problem</h1>
<ul>
<li>There’s an argument that description of the algorithms is akin to a Materials and Methods section. This should provide enough information to replicate the experiment.
<ul>
<li><u> It does not! </u></li>
<li>Algorithmic descriptions often do not match code.</li>
</ul></li>
<li>Hatton (1997) looked at coding errors in scientific codes:
<ul>
<li>8 errors per 1000 lines in commercial C code</li>
<li>12 errors per 1000 lines in commercial Fortran code</li>
<li>“the disagreement among algorithms that are not well specified is several times worse than disagreement among those that are defined formally using mathematics”</li>
</ul></li>
</ul>
<p><em> …but we define our algorithms formally with mathematics in computational fluid dynamics. We must be safe from these errors, right? </em></p>
</section>
<section id="the-problem-closer-to-home-cfd" class="slide level1">
<h1>The problem closer to home: CFD</h1>
<p><img src="images/comp-50.png" /><br /> Kleb and Wood (2004) surveyed 49 new CFD models in IJNMF and JCP. They found that only 22% of the models were published with component level data.</p>
<p><em> In other words, for 78% of those models (algorithms) there’s no easy means to verify that the algorithm is implemented correctly! </em></p>
</section>
<section id="the-solution-in-the-large-scale" class="slide level1">
<h1>The solution: in the large scale</h1>
<p>Augment our traditional means of dissemination when dealing with computational science: publish the simulation code as open source.</p>
<blockquote>
<p>Our view is that we have reached the point that, with some exceptions, anything less than release of actual source code is an indefensible approach for any scientific results that depend on computation, because not releasing such code raises needless, and needlessly confusing, roadblocks to reproducibility.</p>
<blockquote>
<p>– <cite> Ince, Hatton &amp; Graham-Cumming (2011), Nature</cite></p>
</blockquote>
</blockquote>
</section>
<section id="barriers-to-publishing-open-source" class="slide level1">
<h1>Barriers to publishing open source</h1>
<p><small>A survey of attendees (1008 university researchers) at a Machine Learning conference were asked about their perceived barriers to sharing code. The top 10 reasons <u>not</u> to share code.</small></p>
<table>
<caption>Table 10 from [Stodden, 2010]</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">The time it takes to clean up and document for release</td>
<td style="text-align: center;">77.78%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dealing with questions from users about the code</td>
<td style="text-align: center;">51.85%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">The possibility that your code may be used without citation</td>
<td style="text-align: center;">44.78%</td>
</tr>
<tr class="even">
<td style="text-align: left;">The possibility of patents or other IP constraints</td>
<td style="text-align: center;">40.00%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Legal barriers, such as copyright</td>
<td style="text-align: center;">33.72%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Competitors may get an advantage</td>
<td style="text-align: center;">31.85%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">The potential loss of future publications using this code</td>
<td style="text-align: center;">31.11%</td>
</tr>
<tr class="even">
<td style="text-align: left;">The code might be used in commercial applications</td>
<td style="text-align: center;">28.15%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Availability of other code that might substitute for your own</td>
<td style="text-align: center;">21.64%</td>
</tr>
<tr class="even">
<td style="text-align: left;">Whether you put in a large amount of work building the code</td>
<td style="text-align: center;">20.00%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Technical limitations, ie. webspace platform space constraints</td>
<td style="text-align: center;">20.00%</td>
</tr>
</tbody>
</table>
</section>
<section id="the-solution-for-the-scientific-community" class="slide level1">
<h1>The Solution: for the scientific community</h1>
<ul>
<li>A culture of change from within the practitioners of computational science
<ul>
<li>the imperative to publish leaves little time for developing and maintaining high-quality scientific software</li>
<li>there is little reward for open source release in the present climate of research</li>
</ul></li>
<li>Policy to drive behavioural change
<ul>
<li>Insitutional requirements, funding body requirements and journal policies.</li>
<li>3 of the 20 most-cited science journals require source code to be published [Morin et al., 2012]</li>
<li><em>Biostatistics</em>
<ul>
<li>Articles receive markers “D”, “C”, and/or “R”</li>
<li>From July 2009 to July 2011, 21 of 125 received “R”</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-solution-tools-to-help-computational-reproducibility" class="slide level1">
<h1>The Solution: tools to help computational reproducibility</h1>
<ul>
<li>Dissemination platforms
<ul>
<li>ResearchCompendia.org, runmycode.org</li>
<li>github, bitbucket</li>
</ul></li>
<li>Workflow tracking and research environments
<ul>
<li>means to catch complete inputs and outputs from running program: Sumatra, IPython Notebook</li>
<li>capture complete compute environment (virtual machines): GNU Guix, XSEDE, CDE, docker</li>
</ul></li>
<li>Embedded publishing
<ul>
<li>sweave, knitR, org-mode</li>
</ul></li>
</ul>
</section>
<section id="the-solution-in-our-own-back-garden" class="slide level1">
<h1>The Solution: in our own back garden</h1>
<p><em> What we’re doing towards reproducible computational science with eilmer </em></p>
<ul>
<li>open source code release under a GPL(?) licence, hosted on bitbucket</li>
<li>open distribution of supporting documentation under a CreativeCommons licence</li>
<li>adopting (some) best practices from software engineering in the development process
<ul>
<li>revision control</li>
<li>unit testing</li>
<li>integration testing</li>
<li>peer code review</li>
</ul></li>
<li>adopting best practices from computational engineering
<ul>
<li>verification and validation</li>
</ul></li>
</ul>
</section>
<section id="standards-we-are-aiming-for" class="slide level1">
<h1>Standards we are aiming for</h1>
<p>As an example, publication in the <em>Journal of Open Research Software</em> requires the following:</p>
<p><small> 1. Is the software in a suitable repository? <br> 2. Does the software have a suitable open licence? <br> 3. If the Archive section is filled out, is the link in the form of a persistent identifier, e.g. a DOI? Can you download the software from this link? <br> 4. If the Code Repository section is filled out, does the identifier link to the appropriate place to download the source code? Can you download the source code from this link? <br> 5. Is the software license included in the software in the repository? Is it included in the source code? <br> 6. Is sample input and output data provided with the software? <br> 7. Is the code adequately documented? Can a reader understand how to build/deploy/install/run the software, and identify whether the software is operating as expected? <br> 8. Does the software run on the systems specified? <br> 9. Is it obvious what the support mechanisms for the software are? <br> </small></p>
</section>
<section id="the-gold-standards" class="slide level1">
<h1>The “Gold” standards</h1>
<p>From the blog of Cameron Neylon in 2010 on the launch of the journal <em>Open Research Computation</em>:</p>
<p><small><em> The submission criteria for ORC Software Articles are stringent. The source code must be available, on an appropriate public repository under an OSI compliant license. Running code, in the form of executables, or an instance of a service must be made available. Documentation of the code will be expected to a very high standard, consistent with best practice in the language and research domain, and it must cover all public methods and classes. Similarly code testing must be in place covering, by default, 100% of the code. Finally all the claims, use cases, and figures in the paper must have associated with them test data, with examples of both input data and the outputs expected.</p>
<p>The primary consideration for publication in ORC is that your code must be capable of being used, re-purposed, understood, and efficiently built on. You work must be reproducible. In short, we expect the computational work published in ORC to deliver at the level that is expected in experimental research. </em></small></p>
<p><em>Spoiler alert:</em> This journal never published a single article. It did, however, morph into <em>Source Code for Biology and Medicine</em>.</p>
</section>
<section id="direct-reproducibility" class="slide level1">
<h1>Direct reproducibility</h1>
<p>Revision ID is built into the executable and reported in logfile</p>
<pre><code>&gt; e4shared --job=cone20 --prep
Eilmer4 compressible-flow simulation code.
Revision: e1a4f47b18c8 384 default tip
Begin preparation stage for a simulation.</code></pre>
<p>High-level user input is converted to low-level verbose input for simulation. The verbose input is a <u>complete</u> record of input.</p>
<ul>
<li>Win-win: users aren’t confused/overwhelmed by a large amount of input to manage, yet we still get that complete record required for reproducibility</li>
<li>Default arguments aren’t obscured</li>
<li><code>prep-gas</code>, <code>prep-chem</code>, <code>e4shared --prep</code></li>
</ul>
</section>
<section id="unit-testing" class="slide level1">
<h1>Unit testing</h1>
<ul>
<li><p>Unit testing is encouraged for every (non-trivial) method and function in a module.</p></li>
<li><p>Unit tests are coordinated at the package level, see <code>gas</code> and <code>kinetics</code></p></li>
<li><p>Makes heavy use of D language <code>version</code> directive</p></li>
<li><p>Tests coordinated with <code>tcltest</code> module</p></li>
</ul>
<pre class="sourceCode d"><code class="sourceCode d"><span class="kw">version</span>(ideal_gas_test) {
   <span class="dt">int</span> main() {
      <span class="kw">auto</span> gm = <span class="kw">new</span> IdealGas();
      <span class="kw">auto</span> gd = <span class="kw">new</span> GasState(gm, <span class="fl">100.0e3</span>, <span class="fl">300.0</span>);
      gm.update_thermo_from_pT(gd);
      <span class="kw">assert</span>(approxEqual(gd.rho, <span class="fl">1.16109</span>, <span class="fl">1.0e-4</span>), failedUnitTest());
      <span class="kw">return</span> <span class="dv">0</span>;
   }
}</code></pre>
</section>
<section id="integrated-testing" class="slide level1">
<h1>Integrated testing</h1>
<ul>
<li>Complete simulations are performed of selected test cases. The results of these simulations are compared to known “good” answers. If the results differ, we know there’s a problem.</li>
<li>Developers are encouraged to run tests <u>before</u> committing newly developed code.</li>
<li>Broken integration tests are detected spotted by Peter Jacobs very quickly, and by quickly, I mean at approximately the speed of light in a vacuum.</li>
</ul>
<p>Running the integration tests.</p>
<pre><code>&gt; cd dgd/examples/eilmer
&gt; tclsh eilmer-test.tcl</code></pre>
</section>
<section id="best-practices-for-developers" class="slide level1">
<h1>Best practices for developers</h1>
<p>Presently we work with students locally. We have had no external development of the new eilmer code yet. We try to encourage a set of development practices that have served myself and Peter Jacobs very well over a large number of years.</p>
<ul>
<li>Strive for clarity of internal code; code should match verbal description of intention as closely as possible.</li>
<li>Principle of least surprise.</li>
<li>Careful testing of new code before committing to central repository (ie. don’t ruin someone else’s weekend).</li>
<li>Write unit tests.</li>
<li>Write test cases.</li>
<li>Document new modules and implementations in technical reports.</li>
<li>Develop a sense of pride, ownership and reponsibility for your work.</li>
</ul>
<p><em> I see this as a large challenge if we move to a model of encouraging external development on the code. But a challenge I think we should embrace.</em></p>
</section>
<section id="final-best-practice" class="slide level1">
<h1>Final best practice</h1>
<p><em> Don’t commit code after 5pm on a Friday. </em></p>
<p><img src="images/friday-commit.gif" /><br /></p>
</section>
<section id="conclusion" class="slide level1">
<h1>Conclusion</h1>
</section>
<section id="backup-slides" class="slide level1">
<h1>BACKUP SLIDES</h1>
</section>
<section id="examples-of-changing-disclosure-practices" class="slide level1">
<h1>Examples of changing disclosure practices</h1>
<p>Asking for source code release sounds like asking for a lot in terms of changing how we disseminate our work. There are examples in other areas of science where the community has come together and changed disclosure practices:</p>
<ul>
<li>Worldwide Protein Data Bank
<ul>
<li>late 1980s, structural biologists petitioned that to end the data-withhlding practices</li>
<li>deposition of the protein structure became a condition of publication</li>
</ul></li>
<li>Bermuda Principles
<ul>
<li>in genomics, community-driven consensus decided that data should be publicly published prior to publication and within 24 hours of generation</li>
</ul></li>
</ul>
</section>
<!-- {{{{ dzslides core
#
#
#     __  __  __       .  __   ___  __
#    |  \  / /__` |    | |  \ |__  /__`
#    |__/ /_ .__/ |___ | |__/ |___ .__/ core :€
#
#
# The following block of code is not supposed to be edited.
# But if you want to change the behavior of these slides,
# feel free to hack it!
#
-->

<div id="progress-bar"></div>

<!-- Default Style -->
<style>
  * { margin: 0; padding: 0; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
  details { display: none; }
  body {
    width: 800px; height: 600px;
    margin-left: -400px; margin-top: -300px;
    position: absolute; top: 50%; left: 50%;
    overflow: hidden;
  }
  section {
    position: absolute;
    pointer-events: none;
    width: 100%; height: 100%;
  }
  section[aria-selected] { pointer-events: auto; }
  html { overflow: hidden; }
  body { display: none; }
  body.loaded { display: block; }
  .incremental {visibility: hidden; }
  .incremental[active] {visibility: visible; }
  #progress-bar{
    bottom: 0;
    position: absolute;
    -moz-transition: width 400ms linear 0s;
    -webkit-transition: width 400ms linear 0s;
    -ms-transition: width 400ms linear 0s;
    transition: width 400ms linear 0s;
  }
  figure {
    width: 100%;
    height: 100%;
  }
  figure > * {
    position: absolute;
  }
  figure > img, figure > video {
    width: 100%; height: 100%;
  }
</style>

<script>
  var Dz = {
    remoteWindows: [],
    idx: -1,
    step: 0,
    slides: null,
    progressBar : null,
    params: {
      autoplay: "1"
    }
  };

  Dz.init = function() {
    document.body.className = "loaded";
    this.slides = $$("body > section");
    this.progressBar = $("#progress-bar");
    this.setupParams();
    this.onhashchange();
    this.setupTouchEvents();
    this.onresize();
  }
  
  Dz.setupParams = function() {
    var p = window.location.search.substr(1).split('&');
    p.forEach(function(e, i, a) {
      var keyVal = e.split('=');
      Dz.params[keyVal[0]] = decodeURIComponent(keyVal[1]);
    });
  // Specific params handling
    if (!+this.params.autoplay)
      $$.forEach($$("video"), function(v){ v.controls = true });
  }

  Dz.onkeydown = function(aEvent) {
    // Don't intercept keyboard shortcuts
    if (aEvent.altKey
      || aEvent.ctrlKey
      || aEvent.metaKey
      || aEvent.shiftKey) {
      return;
    }
    if ( aEvent.keyCode == 37 // left arrow
      || aEvent.keyCode == 38 // up arrow
      || aEvent.keyCode == 33 // page up
    ) {
      aEvent.preventDefault();
      this.back();
    }
    if ( aEvent.keyCode == 39 // right arrow
      || aEvent.keyCode == 40 // down arrow
      || aEvent.keyCode == 34 // page down
    ) {
      aEvent.preventDefault();
      this.forward();
    }
    if (aEvent.keyCode == 35) { // end
      aEvent.preventDefault();
      this.goEnd();
    }
    if (aEvent.keyCode == 36) { // home
      aEvent.preventDefault();
      this.goStart();
    }
    if (aEvent.keyCode == 32) { // space
      aEvent.preventDefault();
      this.toggleContent();
    }
    if (aEvent.keyCode == 70) { // f
      aEvent.preventDefault();
      this.goFullscreen();
    }
  }

  /* Touch Events */

  Dz.setupTouchEvents = function() {
    var orgX, newX;
    var tracking = false;

    var db = document.body;
    db.addEventListener("touchstart", start.bind(this), false);
    db.addEventListener("touchmove", move.bind(this), false);

    function start(aEvent) {
      aEvent.preventDefault();
      tracking = true;
      orgX = aEvent.changedTouches[0].pageX;
    }

    function move(aEvent) {
      if (!tracking) return;
      newX = aEvent.changedTouches[0].pageX;
      if (orgX - newX > 100) {
        tracking = false;
        this.forward();
      } else {
        if (orgX - newX < -100) {
          tracking = false;
          this.back();
        }
      }
    }
  }

  /* Adapt the size of the slides to the window */

  Dz.onresize = function() {
    var db = document.body;
    var sx = db.clientWidth / window.innerWidth;
    var sy = db.clientHeight / window.innerHeight;
    var transform = "scale(" + (1/Math.max(sx, sy)) + ")";

    db.style.MozTransform = transform;
    db.style.WebkitTransform = transform;
    db.style.OTransform = transform;
    db.style.msTransform = transform;
    db.style.transform = transform;
  }


  Dz.getDetails = function(aIdx) {
    var s = $("section:nth-of-type(" + aIdx + ")");
    var d = s.$("details");
    return d ? d.innerHTML : "";
  }

  Dz.onmessage = function(aEvent) {
    var argv = aEvent.data.split(" "), argc = argv.length;
    argv.forEach(function(e, i, a) { a[i] = decodeURIComponent(e) });
    var win = aEvent.source;
    if (argv[0] === "REGISTER" && argc === 1) {
      this.remoteWindows.push(win);
      this.postMsg(win, "REGISTERED", document.title, this.slides.length);
      this.postMsg(win, "CURSOR", this.idx + "." + this.step);
      return;
    }
    if (argv[0] === "BACK" && argc === 1)
      this.back();
    if (argv[0] === "FORWARD" && argc === 1)
      this.forward();
    if (argv[0] === "START" && argc === 1)
      this.goStart();
    if (argv[0] === "END" && argc === 1)
      this.goEnd();
    if (argv[0] === "TOGGLE_CONTENT" && argc === 1)
      this.toggleContent();
    if (argv[0] === "SET_CURSOR" && argc === 2)
      window.location.hash = "#" + argv[1];
    if (argv[0] === "GET_CURSOR" && argc === 1)
      this.postMsg(win, "CURSOR", this.idx + "." + this.step);
    if (argv[0] === "GET_NOTES" && argc === 1)
      this.postMsg(win, "NOTES", this.getDetails(this.idx));
  }

  Dz.toggleContent = function() {
    // If a Video is present in this new slide, play it.
    // If a Video is present in the previous slide, stop it.
    var s = $("section[aria-selected]");
    if (s) {
      var video = s.$("video");
      if (video) {
        if (video.ended || video.paused) {
          video.play();
        } else {
          video.pause();
        }
      }
    }
  }

  Dz.setCursor = function(aIdx, aStep) {
    // If the user change the slide number in the URL bar, jump
    // to this slide.
    aStep = (aStep != 0 && typeof aStep !== "undefined") ? "." + aStep : ".0";
    window.location.hash = "#" + aIdx + aStep;
  }

  Dz.onhashchange = function() {
    var cursor = window.location.hash.split("#"),
        newidx = 1,
        newstep = 0;
    if (cursor.length == 2) {
      newidx = ~~cursor[1].split(".")[0];
      newstep = ~~cursor[1].split(".")[1];
      if (newstep > Dz.slides[newidx - 1].$$('.incremental > *').length) {
        newstep = 0;
        newidx++;
      }
    }
    this.setProgress(newidx, newstep);
    if (newidx != this.idx) {
      this.setSlide(newidx);
    }
    if (newstep != this.step) {
      this.setIncremental(newstep);
    }
    for (var i = 0; i < this.remoteWindows.length; i++) {
      this.postMsg(this.remoteWindows[i], "CURSOR", this.idx + "." + this.step);
    }
  }

  Dz.back = function() {
    if (this.idx == 1 && this.step == 0) {
      return;
    }
    if (this.step == 0) {
      this.setCursor(this.idx - 1,
                     this.slides[this.idx - 2].$$('.incremental > *').length);
    } else {
      this.setCursor(this.idx, this.step - 1);
    }
  }

  Dz.forward = function() {
    if (this.idx >= this.slides.length &&
        this.step >= this.slides[this.idx - 1].$$('.incremental > *').length) {
        return;
    }
    if (this.step >= this.slides[this.idx - 1].$$('.incremental > *').length) {
      this.setCursor(this.idx + 1, 0);
    } else {
      this.setCursor(this.idx, this.step + 1);
    }
  }

  Dz.goStart = function() {
    this.setCursor(1, 0);
  }

  Dz.goEnd = function() {
    var lastIdx = this.slides.length;
    var lastStep = this.slides[lastIdx - 1].$$('.incremental > *').length;
    this.setCursor(lastIdx, lastStep);
  }

  Dz.setSlide = function(aIdx) {
    this.idx = aIdx;
    var old = $("section[aria-selected]");
    var next = $("section:nth-of-type("+ this.idx +")");
    if (old) {
      old.removeAttribute("aria-selected");
      var video = old.$("video");
      if (video) {
        video.pause();
      }
    }
    if (next) {
      next.setAttribute("aria-selected", "true");
      var video = next.$("video");
      if (video && !!+this.params.autoplay) {
        video.play();
      }
    } else {
      // That should not happen
      this.idx = -1;
      // console.warn("Slide doesn't exist.");
    }
  }

  Dz.setIncremental = function(aStep) {
    this.step = aStep;
    var old = this.slides[this.idx - 1].$('.incremental > *[aria-selected]');
    if (old) {
      old.removeAttribute('aria-selected');
    }
    var incrementals = $$('.incremental');
    if (this.step <= 0) {
      $$.forEach(incrementals, function(aNode) {
        aNode.removeAttribute('active');
      });
      return;
    }
    var next = this.slides[this.idx - 1].$$('.incremental > *')[this.step - 1];
    if (next) {
      next.setAttribute('aria-selected', true);
      next.parentNode.setAttribute('active', true);
      var found = false;
      $$.forEach(incrementals, function(aNode) {
        if (aNode != next.parentNode)
          if (found)
            aNode.removeAttribute('active');
          else
            aNode.setAttribute('active', true);
        else
          found = true;
      });
    } else {
      setCursor(this.idx, 0);
    }
    return next;
  }

  Dz.goFullscreen = function() {
    var html = $('html'),
        requestFullscreen = html.requestFullscreen || html.requestFullScreen || html.mozRequestFullScreen || html.webkitRequestFullScreen;
    if (requestFullscreen) {
      requestFullscreen.apply(html);
    }
  }
  
  Dz.setProgress = function(aIdx, aStep) {
    var slide = $("section:nth-of-type("+ aIdx +")");
    if (!slide)
      return;
    var steps = slide.$$('.incremental > *').length + 1,
        slideSize = 100 / (this.slides.length - 1),
        stepSize = slideSize / steps;
    this.progressBar.style.width = ((aIdx - 1) * slideSize + aStep * stepSize) + '%';
  }
  
  Dz.postMsg = function(aWin, aMsg) { // [arg0, [arg1...]]
    aMsg = [aMsg];
    for (var i = 2; i < arguments.length; i++)
      aMsg.push(encodeURIComponent(arguments[i]));
    aWin.postMessage(aMsg.join(" "), "*");
  }
  
  function init() {
    Dz.init();
    window.onkeydown = Dz.onkeydown.bind(Dz);
    window.onresize = Dz.onresize.bind(Dz);
    window.onhashchange = Dz.onhashchange.bind(Dz);
    window.onmessage = Dz.onmessage.bind(Dz);
  }

  window.onload = init;
</script>


<script> // Helpers
  if (!Function.prototype.bind) {
    Function.prototype.bind = function (oThis) {

      // closest thing possible to the ECMAScript 5 internal IsCallable
      // function 
      if (typeof this !== "function")
      throw new TypeError(
        "Function.prototype.bind - what is trying to be fBound is not callable"
      );

      var aArgs = Array.prototype.slice.call(arguments, 1),
          fToBind = this,
          fNOP = function () {},
          fBound = function () {
            return fToBind.apply( this instanceof fNOP ? this : oThis || window,
                   aArgs.concat(Array.prototype.slice.call(arguments)));
          };

      fNOP.prototype = this.prototype;
      fBound.prototype = new fNOP();

      return fBound;
    };
  }

  var $ = (HTMLElement.prototype.$ = function(aQuery) {
    return this.querySelector(aQuery);
  }).bind(document);

  var $$ = (HTMLElement.prototype.$$ = function(aQuery) {
    return this.querySelectorAll(aQuery);
  }).bind(document);

  $$.forEach = function(nodeList, fun) {
    Array.prototype.forEach.call(nodeList, fun);
  }

</script>
<!-- vim: set fdm=marker: }}} -->
</body>
</html>
